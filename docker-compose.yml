# =============================================================================
# Chronix Docker Compose Configuration
# =============================================================================
#
# Production deployment with Caddy reverse proxy for automatic TLS.
#
# Usage:
#   1. Copy env.example to .env and configure CHRONIX_SESSION_SECRET
#   2. Update Caddyfile with your domain
#   3. docker compose up -d
#   4. docker compose exec chronix chronix init
#   5. Save the generated credentials!
#
# =============================================================================

version: '3.8'

services:
  # ==========================================================================
  # Chronix Application
  # ==========================================================================
  chronix:
    build: .
    container_name: chronix
    restart: unless-stopped
    environment:
      # Security settings (load from .env)
      - CHRONIX_SESSION_SECRET=${CHRONIX_SESSION_SECRET}
      - CHRONIX_SESSION_EXPIRE_HOURS=${CHRONIX_SESSION_EXPIRE_HOURS:-24}
      - CHRONIX_RATE_LIMIT_LOGIN=${CHRONIX_RATE_LIMIT_LOGIN:-5}
      - CHRONIX_RATE_LIMIT_LOGIN_WINDOW=${CHRONIX_RATE_LIMIT_LOGIN_WINDOW:-300}
      - CHRONIX_RATE_LIMIT_WRITE=${CHRONIX_RATE_LIMIT_WRITE:-100}
      - CHRONIX_RATE_LIMIT_WRITE_WINDOW=${CHRONIX_RATE_LIMIT_WRITE_WINDOW:-60}
      - CHRONIX_CORS_ORIGINS=${CHRONIX_CORS_ORIGINS:-}
      
      # Database path (inside container)
      - CHRONIX_DB_PATH=/data/chronix.db
      
      # Behind proxy settings (Caddy handles TLS)
      - CHRONIX_BEHIND_PROXY=true
      
      # Never run debug in production
      - CHRONIX_DEBUG=false
    volumes:
      # Persist database - PROTECT THIS VOLUME
      - chronix-data:/data
    networks:
      - chronix-internal
    # Security: NOT exposed directly - only via reverse proxy
    expose:
      - "8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================================================
  # Caddy Reverse Proxy (TLS Termination)
  # ==========================================================================
  caddy:
    image: caddy:2-alpine
    container_name: chronix-proxy
    restart: unless-stopped
    ports:
      - "80:80"    # HTTP (redirects to HTTPS)
      - "443:443"  # HTTPS
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data      # TLS certificates
      - caddy-config:/config
    networks:
      - chronix-internal
    depends_on:
      - chronix

volumes:
  # Chronix database - contains sensitive operational data
  chronix-data:
    name: chronix-data
  
  # Caddy TLS certificates and data
  caddy-data:
    name: chronix-caddy-data
  caddy-config:
    name: chronix-caddy-config

networks:
  # Internal network - Chronix not exposed to host
  chronix-internal:
    name: chronix-internal
    driver: bridge
